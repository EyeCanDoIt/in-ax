---
title: Peri-op CV Risk ‚Äî Game
layout: template
filename: cvra
---

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Peri-operative CV Risk ‚Äî Interactive Algorithm</title>

<link rel="stylesheet" href="../style.css">
<link rel="stylesheet" href="../assets/css/echo.css">

<style>
  :root{ --side-w: 320px; }

  /* Keep the stage roomy; nothing here shrinks it */
  .echo-image-wrap{ --echo-min-h: 520px; position:relative; }
  @media (max-width: 900px){ .echo-image-wrap{ --echo-min-h: 440px; } }

  /* Main card that holds vignette, question, answers */
  .cv-card{
    position:absolute; inset:16px 16px 16px 16px;
    /* Reserve room for the sidebar so they don't overlap */
    margin-right: calc(var(--side-w) + 16px);
    z-index:3;
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px; background:rgba(2,6,23,.65);
    display:flex; flex-direction:column; padding:14px;
    backdrop-filter:saturate(1.1) blur(2px);
  }
  /* When the layout stacks (tablet/phone), give the card full width */
  @media (max-width: 1100px){
    .cv-card{ margin-right: 0; inset:12px; }
  }

  .cv-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .pill-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .lives-pill,.timer-pill,.best-pill{
    padding:.35rem .6rem; border-radius:999px; background:rgba(15,23,42,.85);
    border:1px solid rgba(255,255,255,.12); color:#e6edf9; font-weight:900;
  }
  .timer-pill.warn{ color:#f59e0b; } .timer-pill.danger{ color:#ef4444; }

  .cv-vignette{ color:#cbd5e1; opacity:.95; margin:.25rem 0 .4rem; line-height:1.35; }
  .cv-question{ color:#e6edf9; font-weight:900; font-size:1.08rem; letter-spacing:.2px; margin:.2rem 0 .2rem; }

  .cv-sub{ color:#a7b4d6; font-weight:800; margin:.45rem 0 .2rem; }
  .cv-conf{ display:flex; align-items:center; gap:10px; }
  .cv-conf input{ flex:1; }
  .cv-conf .cv-chip{ min-width:64px; text-align:center; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); padding:.25rem .5rem; border-radius:10px; font-weight:800; color:#e6edf9; }
  #lifelines button{ margin-left:.35rem; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#e6edf9; border-radius:8px; padding:.25rem .45rem; font-weight:800; cursor:pointer; }
  #lifelines button:disabled{ opacity:.55; cursor:not-allowed; }

  .cv-options{ display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:10px; margin-top:10px; }
  .cv-btn{
    border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
    color:#e6edf9; padding:.7rem .85rem; border-radius:12px; text-align:left; cursor:pointer;
    font-weight:800; transition:.15s ease transform,.15s ease border-color,.15s ease background;
  }
  .cv-btn:hover{ transform:translateY(-1px); border-color:rgba(94,234,212,.35); background:rgba(255,255,255,.10); }
  .cv-btn.ok{ outline:2px solid #34d399; } .cv-btn.no{ outline:2px solid #ef4444; }

  /* Right overlay sidebar (does NOT shrink stage) */
  .cv-sidebar{
    position:absolute; right:16px; top:16px; width:var(--side-w); z-index:4;
    border:1px solid rgba(255,255,255,.12); border-radius:16px;
    background:rgba(2,6,23,.60); padding:12px; display:flex; flex-direction:column; gap:10px;
    pointer-events:auto;
  }
  .cv-side-head{ font-weight:900; color:#e6edf9; letter-spacing:.2px; }
  .cv-gauge{ position:relative; height:120px; border:1px solid rgba(255,255,255,.10); border-radius:12px; background:rgba(255,255,255,.04); }
  .cv-needle{ position:absolute; left:0; top:0; bottom:0; width:40%; border-radius:12px;
    background:linear-gradient(90deg,#34d399,#fbbf24,#ef4444); transition: width .3s ease; }
  .cv-gauge-label{ position:absolute; left:12px; bottom:8px; color:#cbd5e1; font-weight:800; }
  .cv-reveals{ display:flex; flex-direction:column; gap:8px; max-height:230px; overflow:auto; }
  .cv-chip{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:#e6edf9; padding:.35rem .5rem; border-radius:10px; font-weight:800; font-size:.9rem; }
  .cv-links{ display:flex; gap:8px; flex-wrap:wrap; }
  .cv-link{ border:1px solid rgba(94,234,212,.35); color:#a7f3d0; background:rgba(94,234,212,.08); border-radius:10px; padding:.35rem .6rem; font-weight:900; text-decoration:none; }

  /* Stack sidebar on small screens (then the card no longer reserves space) */
  @media (max-width: 1100px){
    .cv-sidebar{ position:static; width:auto; margin-top:10px; }
  }
</style>
</head>
<body class="echo">
  <!-- Header -->
  <header class="container">
    <div class="nav-box">
      <div class="nav-row">
        <a class="brand" href="../" aria-label="In-Ax ‚Äî home">
          <img class="logo" src="https://eyecandoit.github.io/in-ax/images/inaxlogo1.png" alt="In-Ax logo" />
        </a>
        <nav class="tabs" aria-label="Primary">
          <a class="tab" href="../" data-match="/">Home</a>
          <a class="tab" href="../at/" data-match="/at">AT</a>
          <a class="tab" href="../tee/" data-match="/tee">TEE</a>
          <a class="tab" href="../daa/" data-match="/daa">DAA</a>
          <a class="tab active" href="./" data-match="/cvra">CV-Risk</a>
          <a class="tab nav-disclaimer" href="../disclaimer.html"><span class="label-extra">Read </span>Disclaimer</a>
        </nav>
        <div class="subtitle">Interactive peri-operative cardiovascular risk assessment</div>
      </div>
    </div>
  </header>

  <!-- Game -->
  <div class="echo-root">
    <div class="echo-app">
      <div class="echo-header">
        <div class="echo-title-wrap">
          <h1 class="echo-title">Peri-op CV Risk ‚Äî Game</h1>
          <span class="echo-sub">Follow the guideline logic while balancing time and risk</span>
        </div>
        <div class="echo-meta">
          <span id="scorePill" class="echo-pill">Score: 0</span>
          <span id="stepPill" class="echo-pill">Step 1</span>
          <span id="bestPill" class="echo-pill">Best üî• 0</span>
        </div>
      </div>

      <section class="echo-card">
        <div id="topBanner" class="echo-topbanner" hidden></div>

        <div class="echo-stage">
          <div id="wrap" class="echo-image-wrap">
            <!-- Main step card -->
            <div id="cvCard" class="cv-card">
              <div class="cv-head">
                <div class="pill-row">
                  <span id="lives" class="lives-pill" title="Lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                  <span id="timer" class="timer-pill" hidden>20s</span>
                </div>
                <div class="pill-row">
                  <span id="caseSeed" class="echo-pill" title="Sharable seed">Seed</span>
                </div>
              </div>

              <div id="vignette" class="cv-vignette"></div>
              <div id="question" class="cv-question"></div>

              <div class="cv-sub">Confidence</div>
              <div class="cv-conf">
                <input id="conf" type="range" min="0" max="100" value="50">
                <span id="confVal" class="cv-chip">50%</span>
                <div id="lifelines" class="cv-chip">Lifelines:
                  <button id="llHelp">Call consult</button>
                  <button id="llGuide">Guideline</button>
                </div>
              </div>

              <div class="cv-sub">Choose the best next step</div>
              <div id="options" class="cv-options"></div>
            </div>

            <!-- Right overlay sidebar -->
            <aside class="cv-sidebar" aria-label="Case status">
              <div class="cv-side-head">Case status</div>
              <div class="cv-gauge">
                <div id="cvNeedle" class="cv-needle"></div>
                <div class="cv-gauge-label">Peri-op risk</div>
              </div>
              <div id="cvReveals" class="cv-reveals"></div>
              <div class="cv-links">
                <a class="cv-link" target="_blank" rel="noopener"
                   href="https://www.ahajournals.org/doi/10.1161/CIR.0000000000001106">ACC/AHA 2024 Peri-op Guideline ‚Üó</a>
                <a class="cv-link" target="_blank" rel="noopener"
                   href="https://pubmed.ncbi.nlm.nih.gov/?term=perioperative+cardiovascular+risk+assessment">PubMed search ‚Üó</a>
              </div>
            </aside>

            <!-- visual feedback -->
            <div id="flash" class="echo-flash" aria-hidden="true"></div>
            <div id="signal" class="echo-signal" aria-hidden="true"></div>
          </div>
        </div>

        <div class="echo-footer">
          <div class="echo-progress"><div id="bar" class="echo-bar"></div></div>
          <div class="echo-controls">
            <button id="restartBtn" class="echo-link">Restart</button>
          </div>
        </div>
      </section>
    </div>
    <div id="toast" class="echo-toast" role="status" aria-live="polite"></div>
  </div>

  <footer class="container" style="color:#93a1b7; text-align:center; padding:20px 0 28px; font-size:.9rem;">
    ¬© <span id="y"></span> In-Ax
  </footer>

<script>
/* ---------- boot / tabs ---------- */
(function(){
  const path = location.pathname.replace(/\/+$/,'') || '/';
  document.querySelectorAll('.tab').forEach(a=>{
    const m=a.getAttribute('data-match');
    const isRoot = path==='/' || /\/index\.html$/.test(path);
    const on = m==='/'?isRoot : path.includes(m);
    if(on){ a.classList.add('active'); a.setAttribute('aria-selected','true'); }
  });
  document.getElementById('y').textContent = new Date().getFullYear();
})();

/* ---------- helpers ---------- */
const $= (s,el=document)=>el.querySelector(s);
const toast = $('#toast');
function showToast(msg){ toast.textContent = msg; toast.classList.add('echo-show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('echo-show'),1500); }
function flashFeedback(ok){
  const flash=$('#flash'), signal=$('#signal');
  flash.style.setProperty('--echo-flash', ok ? 'rgba(34,197,94,.28)' : 'rgba(248,113,113,.28)'); flash.classList.add('show');
  signal.textContent = ok?'‚úî':'‚úñ'; signal.classList.toggle('ok',ok); signal.classList.toggle('no',!ok); signal.classList.add('show');
  try{ navigator.vibrate?.(ok?35:[25,55,25]); }catch{}
  setTimeout(()=>{ flash.classList.remove('show'); signal.classList.remove('show'); },620);
}
const RNG = (seed=Date.now()%2147483647)=>()=> (seed=seed*48271%2147483647)/2147483647;

/* ---------- state ---------- */
let rng, state, timer=null, tLeft=0, round=0;

function seedFromURL(){
  const p = new URLSearchParams(location.search);
  const s = p.get('seed'); return s? +s : (Math.random()*1e9|0);
}

function buildCase(r){
  const urgent         = r() < 0.25;
  const activeIssues   = r() < 0.20;
  const priorStent     = r() < 0.15;
  const maceHigh       = r() < 0.45;
  const metsGood       = r() < 0.55;
  const testingAffects = r() < 0.55;
  const stressLow      = r() < 0.60;
  const sType = ['low-risk','intermediate','high-risk'][ (maceHigh? (r()<0.5?1:2) : 0) ];
  const surg = ['superficial','orthopedic','intra-abdominal','vascular'][ (maceHigh? (r()<0.5?2:3) : (r()<0.5?0:1)) ];
  const text = [
    urgent? 'Urgent surgery (‚â§24 h). ':'Elective surgery. ',
    `Planned procedure: ${surg}. `,
    activeIssues? 'Active cardiac issue (e.g., ACS/severe valve). ': 'No active cardiac symptoms. ',
    priorStent? 'Prior coronary stent. ':'',
    maceHigh? 'Estimated MACE ‚â•1%. ':'Estimated MACE <1%. ',
    `Functional capacity ${metsGood? '‚â•4':'<4'} METs.`
  ].join('');
  return { urgent, activeIssues, priorStent, maceHigh, metsGood, testingAffects, stressLow, surgType:sType, vignette:text };
}

function startGame(){
  const seed = seedFromURL();
  rng = RNG(seed);
  round++;
  state = {
    seed, step: 'urgent',
    case: buildCase(rng),
    score: 0, streak: +(localStorage.getItem('cvraStreak')||0), best: +(localStorage.getItem('cvraBest')||0),
    lives: 3, risk: 40, reveals: [], mistakes: []
  };
  $('#caseSeed').textContent = 'Seed ' + state.seed;
  updateMeta();
  setRisk(state.risk);
  render();
}

/* ---------- UI meta ---------- */
function setBanner(text,color){ const b=$('#topBanner'); b.textContent=text||''; b.hidden=!text; b.style.color=color||''; }
function setLives(n){ $('#lives').innerHTML = '‚ù§Ô∏è'.repeat(n) + 'üñ§'.repeat(3-n); }
function setRisk(n){ state.risk = Math.max(0,Math.min(100,n)); $('#cvNeedle').style.width = state.risk+'%'; }
function reveal(tag){ const chip=document.createElement('div'); chip.className='cv-chip'; chip.textContent=tag; $('#cvReveals').appendChild(chip); state.reveals.push(tag); }
function updateMeta(){
  $('#scorePill').textContent = `Score: ${state.score} ‚Ä¢ üî• ${state.streak}`;
  $('#bestPill').textContent  = `Best üî• ${state.best}`;
}

/* ---------- timer ---------- */
function startTimer(sec){
  clearInterval(timer);
  tLeft = sec;
  const t = $('#timer'); t.hidden=false; t.textContent = `${tLeft}s`;
  timer = setInterval(()=>{
    tLeft--; t.textContent = `${tLeft}s`;
    t.classList.toggle('warn', tLeft<=7 && tLeft>3);
    t.classList.toggle('danger', tLeft<=3);
    if(tLeft<=0){
      clearInterval(timer);
      state.lives = Math.max(0,state.lives-1); setLives(state.lives);
      setRisk(state.risk+10); flashFeedback(false); showToast('‚è±Ô∏è Time up ‚Äî life lost');
      advanceByGuideline();
    }
  },1000);
}
function stopTimer(){ clearInterval(timer); $('#timer').hidden=true; }

/* ---------- lifelines ---------- */
function refreshLifelines(){
  $('#llHelp').disabled  = state.ll?.help===0;
  $('#llGuide').disabled = state.ll?.guide===0;
}
function attachLifelines(){
  state.ll = { help:1, guide:1 };
  $('#llHelp').onclick = ()=>{
    if(!state.ll.help) return;
    state.ll.help=0; refreshLifelines();
    reveal('üë• Consultant joined'); setRisk(state.risk-8);
    showToast('Consultant on the case');
  };
  $('#llGuide').onclick = ()=>{
    if(!state.ll.guide) return;
    state.ll.guide=0; refreshLifelines();
    setBanner('Guideline: test only if it will change management; limit attempts; optimize risk factors.', '#93c5fd');
  };
}

/* ---------- keyboard shortcuts ---------- */
document.addEventListener('keydown', (e)=>{
  const k=+e.key; const opts = Array.from($('#options').children);
  if(k>=1 && k<=opts.length) opts[k-1].click();
});

/* ---------- step builder ---------- */
function render(){
  const C = state.case;
  setLives(state.lives); updateMeta(); refreshLifelines();

  // Show vignette + make sure the actual question text is in the card
  $('#vignette').textContent = C.vignette;

  const opts = $('#options'); opts.innerHTML='';
  const conf = $('#conf'), confVal=$('#confVal');
  conf.oninput = ()=> confVal.textContent = conf.value+'%';
  confVal.textContent = conf.value+'%';

  // timer per step
  startTimer(C.urgent? 10 : 25);

  let q = { title:'', options:[] };

  switch(state.step){
    case 'urgent':
      q.title = C.urgent? 'Surgery is urgent (‚â§24 h).' : 'Surgery is NOT urgent.';
      q.options = C.urgent ? [
        A('Proceed to surgery now; defer testing not changing management','active', true,{risk:-6, reveal:'Urgent pathway'}),
        A('Delay for stress test','active', false,{risk:+10}),
        A('Admit for prolonged optimization first','active', false,{risk:+8})
      ] : [
        A('Continue risk assessment','active', true,{risk:-2}),
        A('Proceed directly to surgery','finish', false,{risk:+10}),
        A('Order cath lab now','active', false,{risk:+12})
      ];
      break;

    case 'active':
      q.title = 'Any active cardiac conditions (ACS, decomp HF, severe valve, significant arrhythmia)?';
      q.options = C.activeIssues ? [
        A('Delay if possible + multidisciplinary consultation','finish', true,{risk:-8, reveal:'Active issue present'}),
        A('Proceed to surgery','prior', false,{risk:+12}),
        A('Stress test first','prior', false,{risk:+6})
      ] : [
        A('No active issues ‚Äî continue','prior', true,{risk:-4, reveal:'No active cardiac issue'}),
        A('Proceed to surgery now','finish', false,{risk:+8}),
        A('Start noninvasive stress test anyway','prior', false,{risk:+4})
      ];
      break;

    case 'prior':
      q.title = 'Prior coronary stent?';
      q.options = C.priorStent ? [
        A('Consider specialty consult; continue pathway','mace', true,{risk:-2, reveal:'Prior stent'}),
        A('Cancel surgery until stent removed','mace', false,{risk:+6}),
        A('Ignore and proceed','mace', false,{risk:+6})
      ] : [
        A('No prior stent ‚Äî continue','mace', true,{risk:-1, reveal:'No stent history'}),
        A('Order cath lab','mace', false,{risk:+6})
      ];
      break;

    case 'mace':
      q.title = 'Estimated risk of peri-op major adverse cardiac event (MACE) ‚â•1%?';
      q.options = C.maceHigh ? [
        A('Yes ‚Äî evaluate functional capacity next','mets', true,{risk:+2, reveal:'MACE ‚â•1%'}),
        A('Proceed to surgery','finish', false,{risk:+10}),
        A('Skip to stress test','stress', false,{risk:+6})
      ] : [
        A('No ‚Äî proceed to surgery','finish', true,{risk:-6, reveal:'MACE <1%'}),
        A('Do stress test anyway','mets', false,{risk:+5}),
        A('Admit for invasive testing','mets', false,{risk:+8})
      ];
      break;

    case 'mets':
      q.title = 'Functional capacity (METs) ‚â•4?';
      q.options = C.metsGood ? [
        A('Yes ‚Äî proceed to surgery','finish', true,{risk:-6, reveal:'‚â•4 METs'}),
        A('Cardiology consult first','finish', false,{risk:+4}),
        A('Stress test anyway','stress', false,{risk:+5})
      ] : [
        A('No ‚Äî would testing change management?','change', true,{risk:+2, reveal:'<4 METs'}),
        A('Proceed to surgery anyway','finish', false,{risk:+10})
      ];
      break;

    case 'change':
      q.title = 'Would further testing affect decision-making or peri-op care?';
      q.options = C.testingAffects ? [
        A('Yes ‚Äî conduct noninvasive stress testing','stress', true,{risk:+1, reveal:'Testing will change mgmt'}),
        A('No ‚Äî proceed to surgery','finish', false,{risk:+7})
      ] : [
        A('No ‚Äî proceed to surgery','finish', true,{risk:-3, reveal:'Testing wouldn‚Äôt change care'}),
        A('Yes ‚Äî stress test','stress', false,{risk:+5})
      ];
      break;

    case 'stress':
      q.title = 'Noninvasive stress testing result?';
      q.options = C.stressLow ? [
        A('Low-risk findings ‚Äî proceed to surgery','finish', true,{risk:-6, reveal:'Stress: low-risk'}),
        A('Cancel surgery','finish', false,{risk:+4}),
        A('Admit for invasive angiography','finish', false,{risk:+6})
      ] : [
        A('Intermediate/high-risk ‚Äî obtain cardiology consultation','finish', true,{risk:+2, reveal:'Stress: ‚Üërisk'}),
        A('Proceed to surgery anyway','finish', false,{risk:+12})
      ];
      break;

    case 'finish':
      stopTimer();
      return showEnd();
  }

  // Put the actual question into the card (center), not only the banner
  $('#question').textContent = q.title;

  $('#stepPill').textContent = `Step ${stepIndex()}`;
  setBanner('', ''); // keep the top slim banner free for hints only
  attachLifelines();

  q.options.forEach((o,i)=>{
    const b = document.createElement('button');
    b.className='cv-btn';
    b.innerHTML = `<strong>${i+1}. ${o.text}</strong>${o.small?`<div style="opacity:.8;font-weight:700;margin-top:4px">${o.small}</div>`:''}`;
    b.dataset.next = o.next; b.dataset.ok = o.ok?'1':'0';
    b.addEventListener('click', ()=> select(o, b));
    $('#options').appendChild(b);
  });
}

function A(text,next,ok,meta={},small=''){ return { text, next, ok, meta, small }; }
function stepIndex(){
  return ({urgent:1,active:2,prior:3,mace:4,mets:5,change:6,stress:7,finish:8})[state.step] || 1;
}

function select(opt, btn){
  stopTimer();
  if (opt.meta?.risk) setRisk(state.risk + opt.meta.risk);
  if (opt.meta?.reveal) reveal(opt.meta.reveal);

  const conf = +($('#conf').value||50);
  if (opt.ok){
    btn.classList.add('ok'); flashFeedback(true);
    state.score += (conf>=70?2:1);
    state.streak++; state.best=Math.max(state.best,state.streak);
    localStorage.setItem('cvraBest', state.best);
    localStorage.setItem('cvraStreak', state.streak);
  } else {
    btn.classList.add('no'); flashFeedback(false);
    if (conf>=70){ state.lives = Math.max(0, state.lives-1); setLives(state.lives); }
    state.streak = 0; localStorage.setItem('cvraStreak', 0);
    state.mistakes.push({ step: state.step, picked: opt.text });
  }
  updateMeta();

  // reveal the correct option quickly
  Array.from($('#options').children).forEach(el=>{
    if (el!==btn && el.dataset.ok==='1') el.classList.add('ok');
  });

  setTimeout(()=>{
    state.step = opt.next;
    if (state.lives<=0){ state.step='finish'; }
    render();
  }, 700);
}

function advanceByGuideline(){
  const map = { urgent:'active', active:'prior', prior:'mace', mace:'mets', mets:'change', change:'stress', stress:'finish' };
  state.step = map[state.step] || 'finish';
  render();
}

/* ---------- end screen ---------- */
function showEnd(){
  const opts=$('#options'); opts.innerHTML='';
  const ok = state.lives>0;
  const done = document.createElement('div');
  done.style.padding='6px';
  done.innerHTML = `
    <h2 style="margin:.2rem 0 .4rem;color:${ok?'#34d399':'#f87171'}">${ok?'Case complete üéâ':'Case failed'}</h2>
    <p style="color:#cbd5e1;margin:0 0 .4rem">Score: <strong>${state.score}</strong> ‚Ä¢ Streak: <strong>${state.streak}</strong> ‚Ä¢ Best: <strong>${state.best}</strong></p>
    <p style="color:#a7b4d6;margin:0 0 .6rem">Final risk meter: ${Math.round(state.risk)}%. Reveals: ${state.reveals.join(', ')||'‚Äî'}</p>`;
  opts.appendChild(done);

  const restartBtn = document.createElement('button');
  restartBtn.className='cv-btn'; restartBtn.innerHTML='<strong>Play another case</strong>';
  restartBtn.addEventListener('click', restart);
  opts.appendChild(restartBtn);
}

/* ---------- progress / restart ---------- */
function restart(){
  const bar = $('#bar'); const pct = Math.min(100, (round%12)/12*100); bar.style.inset = `0 ${100-pct}% 0 0`;
  startGame();
}

/* ---------- mount ---------- */
attachLifelines();
startGame();
</script>
</body>
</html>
