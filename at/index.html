---
title: Anesthesia Tech Game
layout: template
filename: at
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anesthesia Technician Prep ‚Äî Game</title>

  <!-- Shared site-wide CSS -->
  <link rel="stylesheet" href="../style.css">

  <!-- Reuse the Echo game CSS (it styles the game shell/components) -->
  <link rel="stylesheet" href="../assets/css/echo.css">

  <!-- Page-local CSS for APL arrows + Dual-Blades + Phlebostatic Axis -->
  <style>
    /* ===== APL: big curved arrows that sit just outside the image edges ===== */
    .apl-edge-btn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:none; border:none;
      padding:6px 8px;
      font-size:clamp(42px, 8vw, 80px);
      line-height:1; color:#e8eefc; cursor:pointer;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.55));
      transition: transform .15s ease, opacity .15s ease, color .15s ease;
      z-index:6; user-select:none;
    }
    .apl-edge-btn.left{  left:-16px; }
    .apl-edge-btn.right{ right:-16px; }
    .apl-edge-btn:hover{ transform:translateY(-50%) scale(1.06); color:#fff; }
    .apl-edge-btn:disabled{ opacity:.35; cursor:not-allowed; }

    /* Small readout badge in the image */
    .apl-badge{
      position:absolute; left:12px; top:12px; z-index:6;
      padding:8px 12px; border-radius:10px;
      background:rgba(15,23,42,.75); border:1px solid rgba(255,255,255,.12);
      font-weight:900; font-size:clamp(16px, 2.6vw, 20px); color:#e8eefc;
    }
    .apl-badge small{ font-weight:700; opacity:.9 }

    /* ===== Dual-blades: two side-by-side clickable images with hover highlight ===== */
    .dual-wrap{
      position:absolute; inset:0; display:grid;
      grid-template-columns: 1fr 1fr; gap:12px;
      padding: clamp(8px, 2vw, 16px); pointer-events:none;
      z-index:6; /* above base image & overlay */
    }
    .blade-option{
      pointer-events:auto; position:relative; display:block; border-radius:14px;
      overflow:hidden; isolation:isolate;
      background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.08);
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
      cursor:pointer;
    }
    .blade-option:hover{ transform:translateY(-2px); border-color:rgba(94,234,212,.35); box-shadow:0 14px 30px rgba(0,0,0,.28); }
    .blade-option img{ width:100%; height:100%; object-fit:contain; background:#0e1628; }
    .blade-option.correct{ outline:3px solid #34d399; }
    .blade-option.wrong{ outline:3px solid #f87171; }

    /* ===== Phlebostatic Axis (new) ===== */
    .phleb-wrap{ position:absolute; inset:0; z-index:6; pointer-events:none; }
    .phleb-plane{
      position:absolute; left:8px; right:8px; height:0;
      border-top:2px dashed rgba(207,228,255,.45);
      pointer-events:none;
    }
    .phleb-label{
      position:absolute; right:12px; transform:translateY(-50%);
      background:rgba(15,23,42,.75); border:1px solid rgba(255,255,255,.12);
      color:#cfe4ff; padding:4px 8px; border-radius:8px; font-size:.85rem;
      pointer-events:none;
    }
    .phleb-band{
      position:absolute; left:8px; right:8px;
      background:repeating-linear-gradient(90deg, rgba(94,234,212,.15) 0 20px, rgba(94,234,212,.08) 20px 40px);
      border-top:1px solid rgba(94,234,212,.35);
      border-bottom:1px solid rgba(94,234,212,.35);
      pointer-events:none;
    }
    .transducer{
      position:absolute; width:56px; height:56px; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #e8eefc, #b7c7ef 70%, #8ea0cc);
      border:2px solid rgba(255,255,255,.25);
      box-shadow:0 10px 24px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#0d1b2a; text-shadow:0 1px 0 rgba(255,255,255,.35);
      cursor:grab; pointer-events:auto; user-select:none;
    }
    .transducer:active{ cursor:grabbing; transform:scale(.98); }
    .transducer::after{ content:'Tx'; font-size:.9rem; }
    .phleb-x, .phleb-y{ position:absolute; background:rgba(255,255,255,.12); pointer-events:none; }
    .phleb-x{ top:12px; bottom:12px; width:2px; left:25%; }
    .phleb-y{ top:12px; bottom:12px; width:2px; right:25%; }
  </style>
</head>
<body class="echo">
  <!-- ===== Header: same horizontal bar with tabs ===== -->
  <header class="container">
    <h1 class="sr-only">In-Ax ‚Äî This Picture ‚Äî For Visual Learners</h1>
    <div class="nav-box">
      <div class="nav-row">
        <!-- Logo -->
        <a class="brand" href="../" aria-label="In-Ax ‚Äî home">
          <img class="logo"
               src="https://eyecandoit.github.io/in-ax/images/inaxlogo1.png"
               alt="In-Ax logo" />
        </a>

        <!-- Tabs -->
        <nav class="tabs" aria-label="Primary">
          <a class="tab" href="../" data-match="/">Home</a>
          <a class="tab" href="../about/" data-match="/about">About</a>
          <a class="tab" href="../contact/" data-match="/contact">Contact</a>
          <a class="tab nav-disclaimer" href="../disclaimer.html" target="_self" rel="noopener">
            <span class="label-extra">Read </span>Disclaimer
          </a>
        </nav>

        <!-- Subtitle -->
        <div class="subtitle">Anesthesia Technician Prep ‚Äî learn by playing!</div>
      </div>
    </div>
  </header>

  <!-- ===== Game content ===== -->
  <div class="echo-root">
    <div class="echo-app">
      <div class="echo-header">
        <div class="echo-title-wrap">
          <h1 class="echo-title">Anesthesia Technician Prep</h1>
          <span class="echo-sub">Identify the correct item, part, or step to advance</span>
        </div>

        <div class="echo-meta">
          <span id="echo-scorePill" class="echo-pill">Score: 0</span>
          <span id="echo-qPill" class="echo-pill">1 / 1</span>
        </div>
      </div>

      <section class="echo-card">
        <!-- Top banner used for hints/correct/wrong messages -->
        <div id="echo-topBanner" class="echo-topbanner" hidden></div>

        <div class="echo-stage">
          <div id="echo-imageWrap" class="echo-image-wrap">
            <video id="echo-video" class="echo-image" playsinline muted preload="metadata" style="display:none"></video>
            <img id="echo-image" class="echo-image" src="" alt="Anesthesia tech question image" />
            <div id="echo-overlay" class="echo-overlay"></div>

            <!-- Visual feedback flashes/checkmarks -->
            <div id="echo-flash" class="echo-flash" aria-hidden="true"></div>
            <div id="echo-signal" class="echo-signal" aria-hidden="true"></div>
          </div>
        </div>

        <div id="echo-answers" class="echo-answers" aria-live="polite"></div>

        <div class="echo-footer">
          <div class="echo-progress"><div id="echo-bar" class="echo-bar"></div></div>
          <div class="echo-controls">
            <button id="echo-skipBtn" class="echo-link" title="Skip question">Skip</button>
            <button id="echo-restartBtn" class="echo-link" title="Restart game">Restart</button>
          </div>
        </div>
      </section>
    </div>

    <div id="echo-toast" class="echo-toast" role="status" aria-live="polite"></div>
  </div>

  <footer class="container" style="color:#93a1b7; text-align:center; padding:20px 0 28px; font-size:.9rem;">
    ¬© <span id="y"></span> In-Ax
  </footer>

  <script>
    // Mark active tab (works from subfolders)
    (function(){
      const path = location.pathname.replace(/\/+$/,'') || '/';
      document.querySelectorAll('.tab').forEach(a=>{
        const match = a.getAttribute('data-match');
        const isRoot = path === '' || path === '/' || /\/index\.html$/.test(path);
        const isActive = match === '/' ? isRoot : path.includes(match);
        if(isActive){ a.classList.add('active'); a.setAttribute('aria-selected','true'); }
      });
    })();

    document.getElementById('y').textContent = new Date().getFullYear();

    // ------------ Data ------------
    // Place your generated PNGs in /images/ and keep these paths:
    const ECHO_QUESTIONS = [
      /* ‚îÄ‚îÄ INTERACTIVE: APL valve close direction ‚îÄ‚îÄ */
      { image: "../images/apl-valve.png",
        apl: { start: 10, step: 5, min: 0, max: 70, correct: "cw" }, // 'cw' closes valve
        label: "APL Valve",
        hint: "Target: increase pressure to close",
        topText: "Close the APL valve: which way should you turn?",
        topColor: "#ef4444"
      },

      /* ‚îÄ‚îÄ DUAL-BLADES: hover to highlight; click correct blade (no labels on images) ‚îÄ‚îÄ */
      {
        type: "dual-blades",
        prompt: "Which blade is designed to obtain a view by directly lifting the epiglottis?",
        left:  { src: "../images/mac.png",    key: "mac"    },  // curved
        right: { src: "../images/miller.png", key: "miller" },  // straight
        correctKey: "miller"
      },

      /* ‚îÄ‚îÄ PHLEBOSTATIC AXIS (new) ‚îÄ‚îÄ */
      {
        type: "phleb-axis",
        image: "../images/patient-supine.png",
        prompt: "Place the arterial line transducer at the phlebostatic axis (4th ICS, mid-axillary line ‚Äî right atrium height).",
        axis: { raY: 52, tolerance: 3, showBand: true } // % from top; tune for your art
      },

      /* ‚îÄ‚îÄ Regular multiple-choice items (examples / placeholders) ‚îÄ‚îÄ */
      { image: "../images/ett.JPG",
        label: "Pilot Balloon", target: { x: 40, y: 71.7 },
        choices: ["Bulb","Pilot Balloon","O2 holder","Bellow"],
        answer: "Pilot Balloon",
        hint: "Pilot Balloon",
        topText: "Name this", topColor: "#ef4444" },

      { image: "https://placehold.co/800x600?text=CO2+Detector",
        label: "Colorimetric CO‚ÇÇ Detector", target: { x: 48, y: 50 },
        choices: ["Colorimetric CO‚ÇÇ Detector","Peep Valve","Heat Moisture Exchanger","HME-Filter"],
        answer: "Colorimetric CO‚ÇÇ Detector",
        hint: "Purple‚ÜíYellow indicates CO‚ÇÇ presence" },

      { image: "../images/sodalime.png",
        label: "Soda Lime Canister", target: { x: 6.6, y: 36.2 },
        choices: ["Bacterial Filter","Soda Lime Canister","Fresh Gas Inlet","Expiratory Valve"],
        answer: "Soda Lime Canister",
        hint: "CO‚ÇÇ absorbent stack",
        topText: "What is this?",
        topColor: "#ef4444"
      },

      { image: "../images/sodalime.png",
        label: "Soda Lime Granules", target: { x: 20, y: 41 },
        choices: ["Sodium Hydroxide","H2O","Calcium hydroxide (Ca(OH)‚ÇÇ)","Hydrogen Peroxide"],
        answer: "Calcium hydroxide (Ca(OH)‚ÇÇ)",
        hint: "Soda lime granules",
        topText: "What is the main ingredient of these granules?",
        topColor: "#ef4444"
      },

      { sources: [
          { src: "https://eyecandoit.github.io/in-ax/images/MELongAxisVid1.mp4", type: "video/mp4" },
          { src: "https://eyecandoit.github.io/in-ax/images/MELongAxisVid1.MOV", type: "video/quicktime" }
        ],
        autoplay: true, start: 0.5, end: 2.0,
        label: "Safety Check Step",
        choices: ["O2 Leak Test","Vaporizer Check","Circuit Occlusion","Alarm Limits Set"],
        answer: "Circuit Occlusion",
        hint: "Quick loop for demo only",
        topText: "Name the step shown", topColor: "#ef4444" },
    ];

    // ------------ Helpers ------------
    const $E = (sel, el=document) => el.querySelector(sel);
    const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a };
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    // ------------ State ------------
    let order = shuffle([...Array(ECHO_QUESTIONS.length).keys()]);
    while (
      ECHO_QUESTIONS[order[0]] &&
      !ECHO_QUESTIONS[order[0]].target &&
      !ECHO_QUESTIONS[order[0]].apl &&
      ECHO_QUESTIONS[order[0]].type!=='dual-blades' &&
      ECHO_QUESTIONS[order[0]].type!=='phleb-axis'
    ) {
      order.push(order.shift());
    }
    let idx = 0, score = 0;

    const videoEl   = $E("#echo-video");
    const imageEl   = $E("#echo-image");
    const overlayEl = $E("#echo-overlay");
    const answersEl = $E("#echo-answers");
    const scorePill = $E("#echo-scorePill");
    const qPill     = $E("#echo-qPill");
    const bar       = $E("#echo-bar");
    const toast     = $E("#echo-toast");
    const skipBtn   = $E("#echo-skipBtn");
    const restartBtn= $E("#echo-restartBtn");
    const wrapEl    = $E("#echo-imageWrap");
    const topBanner = $E("#echo-topBanner");
    const flash     = $E("#echo-flash");
    const signal    = $E("#echo-signal");

    // --- NEW: safe image handler token + clearer ---
    let imgToken = 0;
    function clearImageEl(){
      imgToken++;                 // invalidate previous handlers
      imageEl.onload = null;
      imageEl.onerror = null;
      imageEl.removeAttribute('src'); // avoid firing error for ''
    }
    // --- NEW: full video clearer (prevents ‚Äúvideo behind blades/axis‚Äù) ---
    function clearVideoEl(){
      try { videoEl.pause(); } catch {}
      videoEl.ontimeupdate = null;
      while (videoEl.firstChild) videoEl.removeChild(videoEl.firstChild);
      videoEl.removeAttribute('src');
      videoEl.removeAttribute('controls');
      videoEl.style.display = 'none';
    }
    // helper: run after <img> is loaded/visible
    const onImageReady = (fn) => {
      if (imageEl.style.display !== 'none' && imageEl.complete && imageEl.naturalWidth) fn();
      else imageEl.addEventListener('load', fn, { once:true });
    };

    skipBtn.addEventListener('click', nextQuestion);
    restartBtn.addEventListener('click', restart);
    window.addEventListener('resize', redrawOverlay);

    function setAspectFromMedia(){
      if (videoEl && videoEl.style.display !== 'none' && videoEl.videoWidth && videoEl.videoHeight){
        wrapEl.style.setProperty('--echo-ar', `${videoEl.videoWidth} / ${videoEl.videoHeight}`);
      } else if (imageEl.naturalWidth && imageEl.naturalHeight){
        wrapEl.style.setProperty('--echo-ar', `${imageEl.naturalWidth} / ${imageEl.naturalHeight}`);
      }
    }

    function getMediaBox() {
      const r = wrapEl.getBoundingClientRect();
      const isVideo = videoEl && videoEl.style.display !== 'none';
      const natW = isVideo ? videoEl.videoWidth  : imageEl.naturalWidth;
      const natH = isVideo ? videoEl.videoHeight : imageEl.naturalHeight;
      if (!natW || !natH) return { x:0, y:0, w:r.width, h:r.height };

      const mediaAR = natW / natH, wrapAR = r.width / r.height;
      if (wrapAR > mediaAR) {
        const h = r.height, w = h * mediaAR, x = (r.width - w) / 2;
        return { x, y:0, w, h };
      } else {
        const w = r.width, h = w / mediaAR, y = (r.height - h) / 2;
        return { x:0, y, w, h };
      }
    }

    function updateBanner(q){
      const text = (q && (q.topText || q.prompt)) ? String(q.topText || q.prompt) : '';
      if (text){
        topBanner.textContent = text; topBanner.hidden = false; topBanner.style.color = q.topColor || "";
      } else {
        topBanner.textContent = ''; topBanner.hidden = true; topBanner.style.color = "";
      }
    }

    function showImage(src, alt){
      clearVideoEl(); // ensure no video behind images
      overlayEl.innerHTML = '';
      wrapEl.querySelectorAll('.apl-edge-btn,.apl-badge,.dual-wrap,.phleb-wrap').forEach(el => el.remove());

      clearImageEl();
      const my = imgToken;

      imageEl.onload = () => {
        if (my !== imgToken) return; // stale
        setAspectFromMedia(); redrawOverlay();
      };
      imageEl.onerror = () => {
        if (my !== imgToken) return; // stale
        showToast('‚ö†Ô∏è Image failed to load: ' + src);
      };

      imageEl.alt = alt || 'Anesthesia tech image';
      imageEl.style.display = '';
      imageEl.src = src;

      if (imageEl.complete && imageEl.naturalWidth) {
        if (my !== imgToken) return;
        setAspectFromMedia(); redrawOverlay();
      }
    }

    function showVideo(q){
      clearImageEl();
      imageEl.style.display = 'none';
      overlayEl.innerHTML = '';
      wrapEl.querySelectorAll('.apl-edge-btn,.apl-badge,.dual-wrap,.phleb-wrap').forEach(el => el.remove());
      clearVideoEl(); // start clean

      if (Array.isArray(q.sources) && q.sources.length){
        q.sources.forEach(s => {
          const source = document.createElement('source');
          source.src = s.src; if (s.type) source.type = s.type;
          videoEl.appendChild(source);
        });
      } else if (q.video){ videoEl.src = q.video; }

      videoEl.onloadedmetadata = () => {
        setAspectFromMedia();
        const start = typeof q.start === 'number' ? q.start : (typeof q.time === 'number' ? q.time : 0);
        const end   = typeof q.end   === 'number' ? q.end   : null;
        if (start) videoEl.currentTime = start;
        videoEl.ontimeupdate = end ? () => { if (videoEl.currentTime > end) videoEl.currentTime = start || 0; } : null;

        const tryPlay = () => videoEl.play().catch(() => { videoEl.setAttribute('controls',''); });
        if (q.autoplay) { tryPlay(); } else { videoEl.pause(); }
        videoEl.style.display = '';
        redrawOverlay();
      };

      videoEl.onerror = () => showToast('‚ö†Ô∏è Video failed to load');
      videoEl.load();
    }

    function restart(){
      order = shuffle([...Array(ECHO_QUESTIONS.length).keys()]);
      while (
        ECHO_QUESTIONS[order[0]] &&
        !ECHO_QUESTIONS[order[0]].target &&
        !ECHO_QUESTIONS[order[0]].apl &&
        ECHO_QUESTIONS[order[0]].type!=='dual-blades' &&
        ECHO_QUESTIONS[order[0]].type!=='phleb-axis'
      ) {
        order.push(order.shift());
      }
      idx = 0; score = 0; updateMeta();
      showToast('New game started');
      loadQuestion();
    }

    function updateMeta(){
      scorePill.textContent = `Score: ${score}`;
      qPill.textContent = `${idx+1} / ${order.length}`;
      const pct = (idx / order.length) * 100;
      bar.style.inset = `0 ${100-pct}% 0 0`;
    }

    function loadQuestion(){
      const q = ECHO_QUESTIONS[order[idx]];
      // reset visual feedback
      wrapEl.classList.remove('is-correct','is-wrong');
      flash.classList.remove('show');
      signal.classList.remove('show');

      // clear any per-question overlays
      wrapEl.querySelectorAll('.apl-edge-btn,.apl-badge,.dual-wrap,.phleb-wrap').forEach(el => el.remove());

      updateBanner(q);

      if (q.type === 'dual-blades') {
        // fully stop any leftover video, then size wrapper from one PNG and render
        clearVideoEl();
        const probe = new Image();
        probe.onload = () => {
          wrapEl.style.setProperty('--echo-ar', `${probe.width} / ${probe.height}`);
          clearImageEl();
          imageEl.style.display = 'none';
          overlayEl.innerHTML = '';
          buildDualBlades(q);
        };
        probe.src = q.left.src; // could also use q.right.src
      }
      else if (q.type === 'phleb-axis') {
        showImage(q.image, q.prompt || 'Phlebostatic axis');
        onImageReady(()=> renderPhlebAxis(q));
      }
      else if (q.video || q.sources){
        showVideo(q);
      } else if (q.image){
        showImage(q.image, q.hint ? `Question: ${q.hint}` : 'Anesthesia tech image');
      } else {
        showToast('‚ö†Ô∏è Question missing media');
      }

      // Build answers unless special types
      answersEl.innerHTML = '';
      if (q.apl){
        renderAPL(q);
      } else if (q.type === 'dual-blades' || q.type === 'phleb-axis'){
        // no buttons; selection happens on the stage
      } else if (Array.isArray(q.choices)) {
        const options = shuffle(q.choices);
        options.forEach(txt => {
          const btn = document.createElement('button');
          btn.className = 'echo-btn'; btn.type = 'button'; btn.textContent = txt;
          btn.addEventListener('click', () => handleAnswer(btn, txt === q.answer));
          answersEl.appendChild(btn);
        });
      }

      updateMeta();
      setTimeout(redrawOverlay, 0);
    }

    function disableAnswers(){
      answersEl.querySelectorAll('button').forEach(b => b.disabled = true);
    }

    function showBanner(msg, color){
      if (!topBanner) return;
      topBanner.textContent = msg || '';
      topBanner.hidden = !msg;
      topBanner.style.color = color || '';
    }

    function flashFeedback(type /* 'correct' | 'wrong' */){
      wrapEl.classList.remove('is-correct','is-wrong');
      const ok = type === 'correct';
      wrapEl.classList.add(ok ? 'is-correct' : 'is-wrong');

      flash.style.setProperty('--echo-flash', ok ? 'rgba(34,197,94,.28)' : 'rgba(248,113,113,.28)');
      flash.classList.add('show');

      signal.textContent = ok ? '‚úî' : '‚úñ';
      signal.classList.remove('ok','no');
      signal.classList.add(ok ? 'ok' : 'no', 'show');

      try { navigator.vibrate?.(ok ? 35 : [25, 60, 25]); } catch {}
      setTimeout(()=>{ flash.classList.remove('show'); signal.classList.remove('show'); }, 620);
    }

    function highlightCorrectButton(answerText){
      const btns = Array.from(answersEl.querySelectorAll('button'));
      const b = btns.find(x => x.textContent.trim() === String(answerText).trim());
      if (b){ b.classList.add('echo-correct','pulse'); }
    }

    function handleAnswer(btn, isCorrect){
      const q = ECHO_QUESTIONS[order[idx]];
      disableAnswers();

      if (isCorrect){
        btn.classList.add('echo-correct');
        score += 1; scorePill.textContent = `Score: ${score}`;
        showBanner('‚úÖ Correct', '#34d399');
        flashFeedback('correct');
        try { if (q && q.label && q.target) placeLabel(q.label); } catch(e){}
        setTimeout(()=>{ showBanner(''); nextQuestion(); }, 900);
      } else {
        btn.classList.add('echo-wrong');
        answersEl.addEventListener('animationend',()=>answersEl.classList.remove('echo-shake'),{once:true});
        answersEl.classList.add('echo-shake');
        showBanner(`‚ùå Incorrect${q.answer ? ' ‚Äî Correct: ' + q.answer : ''}`, '#f87171');
        flashFeedback('wrong');
        highlightCorrectButton(q.answer);
        setTimeout(()=>{ showBanner(''); nextQuestion(); }, 1100);
      }
    }

    function placeLabel(text){
      if (!overlayEl) return;
      const q = ECHO_QUESTIONS[order[idx]];
      if (!q || !q.target) return;

      const r   = wrapEl.getBoundingClientRect();
      const box = getMediaBox();
      const x2  = box.x + box.w * (q.target.x/100);
      const y2  = box.y + box.h * (q.target.y/100);

      const x1 = clamp(x2 - 140, 20, r.width  - 20);
      const y1 = clamp(y2 - 100, 20, r.height - 20);

      const label = document.createElement('div');
      label.className = 'echo-arrow-label';
      label.style.left = x1 + 'px'; label.style.top  = y1 + 'px';
      label.textContent = text;
      overlayEl.appendChild(label);
    }

    function nextQuestion(){
      if(idx < order.length - 1){
        idx += 1; updateMeta(); loadQuestion();
      } else {
        finish();
      }
    }

    function finish(){
      overlayEl.innerHTML = '';
      answersEl.innerHTML = '';
      const done = document.createElement('div');
      done.style.padding = '22px';
      done.innerHTML = `<h2 style="margin:.2rem 0 .6rem;color:#e6edf9">Nice work! üéâ</h2>
        <p style="color:#c2cce0; margin:0 0 1rem">You scored <strong>${score}</strong> / ${order.length}.</p>`;
      answersEl.appendChild(done);
      showToast('Game complete');
    }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('echo-show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('echo-show'), 1500);
    }

    function redrawOverlay(){
      const q = ECHO_QUESTIONS[order[idx]];
      overlayEl.innerHTML = '';
      if(!q || !q.target) return;

      const r   = wrapEl.getBoundingClientRect();
      const box = getMediaBox();
      const x2  = box.x + box.w * (q.target.x/100);
      const y2  = box.y + box.h * (q.target.y/100);

      const x1 = clamp(x2 - 140, 20, r.width  - 20);
      const y1 = clamp(y2 - 100, 20, r.height - 20);

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('class','echo-svg');

      const defs = document.createElementNS(svgNS, 'defs');
      const marker = document.createElementNS(svgNS, 'marker');
      marker.setAttribute('id','echo-arrowhead');
      marker.setAttribute('markerWidth','10');
      marker.setAttribute('markerHeight','10');
      marker.setAttribute('refX','6');
      marker.setAttribute('refY','3');
      marker.setAttribute('orient','auto');
      const head = document.createElementNS(svgNS,'polygon');
      head.setAttribute('points','0 0, 6 3, 0 6');
      head.setAttribute('class','echo-arrow-head');
      marker.appendChild(head); defs.appendChild(marker); svg.appendChild(defs);

      const line = document.createElementNS(svgNS,'line');
      line.setAttribute('x1', x1); line.setAttribute('y1', y1);
      line.setAttribute('x2', x2); line.setAttribute('y2', y2);
      line.setAttribute('class','echo-arrow-line');
      line.setAttribute('marker-end','url(#echo-arrowhead)');
      svg.appendChild(line);
      overlayEl.appendChild(svg);

      const dot = document.createElement('div');
      dot.style.cssText = 'position:absolute;width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.85);box-shadow:0 0 10px rgba(255,255,255,.7);transform:translate(-50%,-50%);';
      dot.style.left = x2+'px'; dot.style.top = y2+'px';
      overlayEl.appendChild(dot);
    }

    /* ===== APL interactive: arrows + badge next to the image ===== */
    function renderAPL(q){
      // badge (top-left) showing the dial value
      const badge = document.createElement('div');
      const state = { val: q.apl?.start ?? 10, graded:false };
      badge.className = 'apl-badge';
      const updateBadge = () => badge.innerHTML = `${state.val}<small> cmH<sub>2</sub>O</small>`;
      updateBadge();
      wrapEl.appendChild(badge);

      // big curved arrows (‚Ü∫ / ‚Üª) next to the image
      const mkBtn = (dir, label, glyph, extraClass) => {
        const b = document.createElement('button');
        b.className = `apl-edge-btn ${extraClass}`;
        b.type = 'button';
        b.setAttribute('aria-label', label);
        b.dataset.dir = dir;
        b.textContent = glyph;
        return b;
      };
      const btnLeft  = mkBtn('ccw','Turn counter-clockwise','‚Ü∫','left');
      const btnRight = mkBtn('cw','Turn clockwise','‚Üª','right');
      wrapEl.append(btnLeft, btnRight);

      const step = q.apl?.step ?? 5;
      const min  = q.apl?.min ?? 0;
      const max  = q.apl?.max ?? 70;
      const correctDir = (q.apl?.correct || 'cw');

      function disableAPLBtns(){ btnLeft.disabled = true; btnRight.disabled = true; }

      function clickDir(dir){
        // update readout (visual)
        state.val = clamp(state.val + (dir==='cw' ? step : -step), min, max);
        updateBadge();

        if (state.graded) return;     // grade only on the first click
        state.graded = true;
        const ok = (dir === correctDir);
        disableAPLBtns();

        if (ok){
          score += 1; scorePill.textContent = `Score: ${score}`;
          showBanner('‚úÖ Correct', '#34d399');
          flashFeedback('correct');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 900);
        } else {
          showBanner(`‚ùå Incorrect ‚Äî closes ${correctDir==='cw'?'clockwise':'counter-clockwise'}`, '#f87171');
          flashFeedback('wrong');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 1100);
        }
      }

      btnLeft .addEventListener('click', ()=> clickDir('ccw'));
      btnRight.addEventListener('click', ()=> clickDir('cw'));
    }

    /* ===== Dual-blades interactive ===== */
    function buildDualBlades(q){
      // Safety: ensure base image is hidden so it doesn't show behind overlays
      imageEl.style.display = 'none';
      // Safety: absolutely hide any video
      clearVideoEl();

      const wrap = document.createElement('div');
      wrap.className = 'dual-wrap';

      const make = (side) => {
        const opt = document.createElement('button');
        opt.type = 'button';
        opt.className = 'blade-option';
        const img = document.createElement('img');
        img.alt = 'Blade option';
        img.src = q[side].src;
        opt.dataset.key = q[side].key;
        opt.appendChild(img);
        return opt;
      };

      const left  = make('left');
      const right = make('right');
      wrap.append(left, right);
      wrapEl.appendChild(wrap);

      function choose(el){
        const ok = el.dataset.key === q.correctKey;
        left.disabled = right.disabled = true;
        el.classList.add(ok ? 'correct' : 'wrong');

        if (ok){
          score += 1; scorePill.textContent = `Score: ${score}`;
          showBanner('‚úÖ Correct', '#34d399');
          flashFeedback('correct');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 900);
        } else {
          showBanner('‚ùå Incorrect ‚Äî the straight blade (Miller) directly lifts the epiglottis.', '#f87171');
          flashFeedback('wrong');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 1100);
        }
      }

      left.addEventListener('click',  ()=> choose(left));
      right.addEventListener('click', ()=> choose(right));
    }

    /* ===== Phlebostatic Axis interactive ===== */
    function renderPhlebAxis(q){
      const wrap = document.createElement('div');
      wrap.className = 'phleb-wrap';
      wrapEl.appendChild(wrap);

      // Decorative X/Y guides
      const xGuide = document.createElement('div'); xGuide.className='phleb-x';
      const yGuide = document.createElement('div'); yGuide.className='phleb-y';
      wrap.append(xGuide, yGuide);

      // Target plane settings
      const { raY=52, tolerance=3, showBand=true } = q.axis || {};
      const box = getMediaBox();
      const toPxY = pct => box.y + box.h * (pct/100);

      // Acceptable band (optional)
      const band = document.createElement('div');
      band.className = 'phleb-band';
      const bandTop = toPxY(raY - tolerance), bandH = toPxY(raY + tolerance) - bandTop;
      band.style.top = bandTop + 'px'; band.style.height = bandH + 'px';
      if (showBand) wrap.appendChild(band);

      // Plane + label
      const plane = document.createElement('div');
      plane.className = 'phleb-plane';
      plane.style.top = toPxY(raY) + 'px';
      const label = document.createElement('div');
      label.className = 'phleb-label';
      label.textContent = 'RA level (4th ICS, MAL)';
      plane.appendChild(label);
      wrap.appendChild(plane);

      // Draggable transducer
      const tx = document.createElement('div');
      tx.className = 'transducer';
      let px = box.x + box.w * .5;
      let py = box.y + box.h * .5;
      const place = () => { tx.style.left = (px - 28) + 'px'; tx.style.top = (py - 28) + 'px'; };
      place(); wrap.appendChild(tx);

      // drag logic
      let drag = false, offX=0, offY=0, graded=false;
      tx.addEventListener('pointerdown', e=>{
        drag = true; tx.setPointerCapture(e.pointerId);
        offX = e.clientX - px; offY = e.clientY - py;
      });
      tx.addEventListener('pointermove', e=>{
        if(!drag) return;
        px = clamp(e.clientX - offX, box.x, box.x + box.w);
        py = clamp(e.clientY - offY, box.y, box.y + box.h);
        place();
      });
      tx.addEventListener('pointerup', ()=>{ drag=false; if(!graded) grade(); });

      // click-to-set convenience
      wrapEl.addEventListener('click', e=>{
        if (graded) return;
        const r = wrapEl.getBoundingClientRect();
        const within = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
        if (!within) return;
        px = clamp(e.clientX, box.x, box.x + box.w);
        py = clamp(e.clientY, box.y, box.y + box.h);
        place(); grade();
      }, { once:false });

      function grade(){
        graded = true;
        const yPct = clamp(((py - box.y) / box.h) * 100, 0, 100);
        const ok = Math.abs(yPct - raY) <= tolerance;
        if (ok){
          score += 1; scorePill.textContent = `Score: ${score}`;
          showBanner('‚úÖ Correct ‚Äî transducer leveled to RA (phlebostatic axis)', '#34d399');
          flashFeedback('correct');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 1000);
        } else {
          showBanner('‚ùå Not quite ‚Äî level at 4th ICS on the mid-axillary line (RA height).', '#f87171');
          flashFeedback('wrong');
          setTimeout(()=>{ showBanner(''); nextQuestion(); }, 1400);
        }
      }
    }

    // ‚îÄ‚îÄ DEV coordinate picker (?dev=1) ‚îÄ‚îÄ
    const DEV = new URLSearchParams(location.search).has('dev');
    if (DEV) {
      const controls = $E('.echo-controls');
      const devBtn = document.createElement('button');
      devBtn.id = 'echo-devBtn';
      devBtn.className = 'echo-link';
      devBtn.textContent = 'Pick coords (D)';
      controls.appendChild(devBtn);

      let devMode = false;
      function toggleDevMode(){
        devMode = !devMode;
        devBtn.textContent = devMode ? 'Picking‚Ä¶ (D to exit)' : 'Pick coords (D)';
        showToast(devMode ? 'Tap the image/video to copy % coords' : 'Picker off');
        if (devMode && videoEl && videoEl.style.display !== 'none'){
          try { videoEl.pause(); } catch {}
        }
      }

      devBtn.addEventListener('click', toggleDevMode);
      window.addEventListener('keydown', e => { if (e.key.toLowerCase() === 'd') toggleDevMode(); });

      wrapEl.addEventListener('click', (e) => {
        if (!devMode) return;
        const r = wrapEl.getBoundingClientRect();
        const box = getMediaBox();

        const px = e.clientX - r.left;
        const py = e.clientY - r.top;

        const xPct = clamp(((px - box.x) / box.w) * 100, 0, 100);
        const yPct = clamp(((py - box.y) / box.h) * 100, 0, 100);

        const x = Math.round(xPct * 10) / 10;
        const y = Math.round(yPct * 10) / 10;
        const snippet = `target: { x: ${x}, y: ${y} }`;

        const dot = document.createElement('div');
        dot.style.cssText =
          `position:absolute;left:${px}px;top:${py}px;width:12px;height:12px;border-radius:999px;`+
          `background:#5eead4;box-shadow:0 0 12px rgba(94,234,212,.8);`+
          `transform:translate(-50%,-50%);pointer-events:none`;
        overlayEl.appendChild(dot);
        setTimeout(()=>dot.remove(), 900);

        navigator.clipboard?.writeText(snippet).catch(()=>{});
        showToast(`Copied: ${snippet}`);
      });
    }

    // Init
    loadQuestion();
  </script>
</body>
</html>
